// Modelo de datos para Sistema POS - Tienda Minorista
// Base de datos: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// USUARIOS Y AUTENTICACIÓN
// =====================================================

enum UserRole {
  ADMIN
  SELLER
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  role          UserRole  @default(SELLER)
  isActive      Boolean   @default(true) @map("is_active")
  failedAttempts Int      @default(0) @map("failed_attempts")
  lockedUntil   DateTime? @map("locked_until")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relaciones
  sales               Sale[]
  inventoryMovements  InventoryMovement[]
  auditLogs           AuditLog[]
  refreshTokens       RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// =====================================================
// CATÁLOGO DE PRODUCTOS
// =====================================================

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  products Product[]

  @@map("categories")
}

model Product {
  id           String   @id @default(uuid())
  sku          String   @unique
  barcode      String?  @unique
  name         String
  description  String?
  categoryId   String   @map("category_id")
  brand        String?
  size         String?
  color        String?
  salePrice    Decimal  @map("sale_price") @db.Decimal(12, 2)
  costPrice    Decimal? @map("cost_price") @db.Decimal(12, 2)
  taxRate      Decimal  @default(0) @map("tax_rate") @db.Decimal(5, 4) // Ej: 0.16 = 16%
  unit         String   @default("unidad") // unidad, paquete, etc.
  imageUrl     String?  @map("image_url")
  minStock     Int      @default(0) @map("min_stock")
  currentStock Int      @default(0) @map("current_stock")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  category           Category            @relation(fields: [categoryId], references: [id])
  inventoryMovements InventoryMovement[]
  saleItems          SaleItem[]

  @@index([name])
  @@index([sku])
  @@index([barcode])
  @@map("products")
}

// =====================================================
// INVENTARIO (KARDEX)
// =====================================================

enum MovementType {
  ENTRY      // Entrada (compra/abastecimiento)
  SALE       // Salida por venta
  ADJUSTMENT // Ajuste por inventario físico
  RETURN     // Devolución
  VOID       // Anulación de venta
}

model InventoryMovement {
  id            String       @id @default(uuid())
  productId     String       @map("product_id")
  userId        String       @map("user_id")
  type          MovementType
  quantity      Int          // Positivo para entradas, negativo para salidas
  previousStock Int          @map("previous_stock")
  newStock      Int          @map("new_stock")
  unitCost      Decimal?     @map("unit_cost") @db.Decimal(12, 2)
  reason        String?      // Motivo obligatorio para ajustes
  referenceId   String?      @map("reference_id") // ID de venta u otro documento
  referenceType String?      @map("reference_type") // "sale", "return", etc.
  createdAt     DateTime     @default(now()) @map("created_at")

  // Relaciones
  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([createdAt])
  @@map("inventory_movements")
}

// =====================================================
// VENTAS
// =====================================================

enum SaleStatus {
  COMPLETED
  VOIDED
  PARTIAL_RETURN
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  MIXED
}

model Sale {
  id              String        @id @default(uuid())
  receiptNumber   Int           @unique @map("receipt_number")
  userId          String        @map("user_id")
  status          SaleStatus    @default(COMPLETED)
  subtotal        Decimal       @db.Decimal(12, 2)
  discountAmount  Decimal       @default(0) @map("discount_amount") @db.Decimal(12, 2)
  taxAmount       Decimal       @default(0) @map("tax_amount") @db.Decimal(12, 2)
  total           Decimal       @db.Decimal(12, 2)
  paymentMethod   PaymentMethod @map("payment_method")
  amountPaid      Decimal       @map("amount_paid") @db.Decimal(12, 2)
  changeAmount    Decimal       @default(0) @map("change_amount") @db.Decimal(12, 2)
  notes           String?
  voidReason      String?       @map("void_reason")
  voidedAt        DateTime?     @map("voided_at")
  voidedBy        String?       @map("voided_by")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relaciones
  user    User       @relation(fields: [userId], references: [id])
  items   SaleItem[]
  returns Return[]

  @@index([createdAt])
  @@index([userId])
  @@map("sales")
}

model SaleItem {
  id              String  @id @default(uuid())
  saleId          String  @map("sale_id")
  productId       String  @map("product_id")
  productName     String  @map("product_name") // Snapshot
  productSku      String  @map("product_sku")  // Snapshot
  quantity        Int
  unitPrice       Decimal @map("unit_price") @db.Decimal(12, 2)    // Snapshot del precio
  discountPercent Decimal @default(0) @map("discount_percent") @db.Decimal(5, 2)
  discountAmount  Decimal @default(0) @map("discount_amount") @db.Decimal(12, 2)
  taxRate         Decimal @default(0) @map("tax_rate") @db.Decimal(5, 4)   // Snapshot
  taxAmount       Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  subtotal        Decimal @db.Decimal(12, 2) // (unitPrice * quantity) - discountAmount
  total           Decimal @db.Decimal(12, 2) // subtotal + taxAmount
  returnedQty     Int     @default(0) @map("returned_qty")

  // Relaciones
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

// =====================================================
// DEVOLUCIONES
// =====================================================

model Return {
  id            String   @id @default(uuid())
  returnNumber  Int      @unique @map("return_number")
  saleId        String   @map("sale_id")
  userId        String   @map("user_id")
  reason        String
  totalRefund   Decimal  @map("total_refund") @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @map("created_at")

  // Relaciones
  sale  Sale         @relation(fields: [saleId], references: [id])
  items ReturnItem[]

  @@map("returns")
}

model ReturnItem {
  id         String  @id @default(uuid())
  returnId   String  @map("return_id")
  productId  String  @map("product_id")
  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(12, 2)
  refundAmount Decimal @map("refund_amount") @db.Decimal(12, 2)

  // Relaciones
  return Return @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@map("return_items")
}

// =====================================================
// CONFIGURACIÓN DE TIENDA
// =====================================================

model StoreConfig {
  id              String   @id @default("store_config")
  storeName       String   @default("Mi Tienda") @map("store_name")
  storeNit        String?  @map("store_nit")
  storeAddress    String?  @map("store_address")
  storePhone      String?  @map("store_phone")
  storeEmail      String?  @map("store_email")
  logoUrl         String?  @map("logo_url")
  primaryColor    String   @default("#3B82F6") @map("primary_color")
  secondaryColor  String   @default("#1E40AF") @map("secondary_color")
  accentColor     String   @default("#F59E0B") @map("accent_color")
  darkMode        Boolean  @default(false) @map("dark_mode")
  allowNegativeStock Boolean @default(false) @map("allow_negative_stock")
  maxLoginAttempts Int     @default(5) @map("max_login_attempts")
  lockoutMinutes  Int      @default(15) @map("lockout_minutes")
  defaultTaxRate  Decimal  @default(0) @map("default_tax_rate") @db.Decimal(5, 4)
  receiptFooter   String?  @map("receipt_footer")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("store_config")
}

// =====================================================
// CONSECUTIVOS
// =====================================================

model Sequence {
  id          String @id
  currentValue Int   @default(0) @map("current_value")

  @@map("sequences")
}

// =====================================================
// AUDITORÍA
// =====================================================

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, VOID, etc.
  entity       String   // product, sale, user, inventory, config, etc.
  entityId     String?  @map("entity_id")
  oldValues    Json?    @map("old_values")
  newValues    Json?    @map("new_values")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")

  // Relaciones
  user User? @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
